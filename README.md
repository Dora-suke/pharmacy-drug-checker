# 薬局向け医薬品供給状況チェッカー

薬局スタッフが、自薬局で扱っている薬のリストと厚生労働省の「医薬品供給状況」Excelを照合し、「直近10日以内に更新された薬品」を素早く確認できる Web アプリケーションです。

## 技術スタック

- **フレームワーク**: FastAPI + Uvicorn
- **フロントエンド**: htmx + Bootstrap 5 + Jinja2
- **データ処理**: pandas + openpyxl
- **HTTP通信**: httpx
- **スクレイピング**: beautifulsoup4 + lxml
- **パッケージ管理**: uv

## プロジェクト構造

```
pharmacy-drug-checker/
├── pyproject.toml              # 依存関係定義
├── main.py                     # FastAPI エントリーポイント
├── create_sample.py            # サンプルExcel生成スクリプト
├── app/
│   ├── __init__.py
│   ├── config.py               # 定数・パス設定
│   ├── mhlw_downloader.py      # 厚労省Excelダウンロード・キャッシュ管理
│   └── excel_matcher.py        # Excel照合ロジック
├── templates/
│   └── index.html              # UIレイアウト
├── static/
│   └── custom.css              # カスタムスタイル
├── cache/                      # ダウンロード厚労省Excel保存
│   └── .gitkeep
└── sample/
    └── pharmacy_sample.xlsx    # サンプルExcel（動作確認用）
```

## セットアップと実行

### 1. 依存関係のインストール

```bash
cd /Users/nori3/Desktop/desktop/pharmacy-drug-checker
uv sync
```

### 2. アプリケーションの起動

```bash
uv run uvicorn main:app --reload --port 8000
```

起動後、ブラウザで `http://localhost:8000` にアクセスしてください。

## 使用方法

### 基本的な流れ

1. **厚労省データ自動取得**: アプリ起動時に自動で最新の厚労省データをダウンロード・キャッシュします
2. **ファイルアップロード**: 薬局で管理している医薬品リスト（Excel）を選択
3. **照合実行**: 「照合実行」ボタンをクリック
4. **結果確認**: 10日以内に更新された医薬品が表示されます

### 🔄 更新確認ボタン

厚労省データを手動で更新したい場合、ヘッダーの「🔄 更新確認」ボタンをクリックしてください。

- ETag / Last-Modified をチェック
- 差異があればダウンロード
- 差異がなければキャッシュを利用（再ダウンロードなし）

## サンプルExcel形式

`sample/pharmacy_sample.xlsx` に動作確認用のサンプルが含まれています。

### 必須列

| 列名 | 説明 |
|---|---|
| 薬品コード | YJコード（照合キー） |
| 薬品名 | 薬局管理名（照合フォールバック） |

### 推奨列

| 列名 | 説明 |
|---|---|
| 規格 | 規格・容量 |
| メーカー | 製造販売業者 |
| 採用区分 | 採用中/削除予定等 |

## 照合ロジック

1. **薬品コード優先**: YJコード→正規化→マッチング
2. **名前フォールバック**: コードマッチが失敗した場合は薬品名で照合
3. **正規化処理**: 全角英数字を半角に統一（NFKC）
4. **日付フィルタリング**: 実行日から過去10日以内の更新のみ抽出

## キャッシュ管理

### メタ情報ファイル

`cache/mhlw_meta.json` に以下を保存：

```json
{
  "etag": "...",
  "last_modified": "...",
  "content_length": "...",
  "downloaded_at": "2024-01-15T10:30:00",
  "url": "https://..."
}
```

### キャッシュの更新タイミング

- **自動**: 起動時に厚労省サーバーをチェック
- **手動**: UIの「🔄 更新確認」ボタン
- **更新判定**: ETag または Last-Modified の差異で判定

## トラブルシューティング

### ダウンロードが失敗する場合

- ネットワーク接続を確認
- 厚労省サイトの稼働状況を確認
- キャッシュディレクトリの書き込み権限を確認

### 照合結果が表示されない場合

- Excelのフォーマット（列名）を確認
- サンプルExcel（`sample/pharmacy_sample.xlsx`）と比較
- ブラウザのコンソール（F12）でエラーメッセージを確認

### 厚労省データが古い場合

- 「🔄 更新確認」をクリックして手動更新
- `cache/` ディレクトリの内容を削除して再度アプリを起動

## 注意事項

- サンプルデータ（`sample/pharmacy_sample.xlsx`）には架空データが使用されています
- 実際の薬局では、ユーザーが実際のデータで差し替えてください
- 10日間のフィルタリング期間は `app/config.py` の `DAYS_BACK` で変更可能

## ライセンス

MIT License
