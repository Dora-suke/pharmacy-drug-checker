<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è–¬å±€å‘ã‘åŒ»è–¬å“ä¾›çµ¦çŠ¶æ³ãƒã‚§ãƒƒã‚«ãƒ¼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        body { display: flex; flex-direction: column; }
        .main-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .results-area { flex: 1; overflow-y: auto; }
        /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã® flex è¨­å®š */
        .tab-content { display: flex !important; flex-direction: column; height: 100%; width: 100%; }
        /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ãƒšã‚¤ãƒ³ã¯ flex ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä¿æŒ */
        .tab-pane {
            overflow: visible;
            height: 100% !important;
            width: 100% !important;
            display: none !important;
            flex-direction: column;
        }
        .tab-pane.active {
            display: flex !important;
            flex-direction: column;
            height: 100% !important;
            width: 100% !important;
        }
    </style>
</head>
<body>
    <div class="main-container p-3">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">è–¬å±€å‘ã‘åŒ»è–¬å“ä¾›çµ¦çŠ¶æ³ãƒã‚§ãƒƒã‚«ãƒ¼</h1>
                <div class="d-flex gap-2 align-items-center">
                    <small class="text-muted" id="last-updated">{% if status.downloaded_at %}æœ€çµ‚æ›´æ–°: {{ status.downloaded_at }}{% else %}æœªæ›´æ–°{% endif %}</small>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshData()" title="åšç”ŸåŠ´åƒçœã®æœ€æ–°ã®åŒ»è–¬å“ä¾›çµ¦æƒ…å ±ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦æ›´æ–°">
                        ğŸ”„ åšåŠ´çœãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                    </button>
                </div>
            </div>
        </div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
        <div id="status-area" style="display: none;">
            <div class="alert mb-3" id="status-msg"></div>
        </div>

        <!-- ã‚¿ãƒ–UI -->
        <div class="card flex-grow-1" style="overflow: hidden; display: flex; flex-direction: column;">
            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="card-header" style="padding: 0;">
                <ul class="nav nav-tabs" role="tablist" style="border-bottom: none; margin-bottom: 0;">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-check" data-bs-toggle="tab" data-bs-target="#content-check" type="button" role="tab">
                            ğŸ“‹ ãƒ•ã‚¡ã‚¤ãƒ«ç…§åˆ
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-preview" data-bs-toggle="tab" data-bs-target="#content-preview" type="button" role="tab">
                            ğŸ“„ ä¾›çµ¦æƒ…å ±ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                        </button>
                    </li>
                </ul>
            </div>

            <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div class="tab-content flex-grow-1" style="overflow: hidden;">
                <!-- ãƒ•ã‚¡ã‚¤ãƒ«ç…§åˆã‚¿ãƒ– -->
                <div class="tab-pane fade show active" id="content-check" role="tabpanel" style="overflow: hidden; padding: 0; margin: 0;">
                    <div class="card-body" style="display: flex; flex-direction: column; overflow: hidden; padding: 0; margin: 0; min-height: 0;">
                        <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ -->
                        <div style="padding: 0.5rem; flex: 0 0 auto; margin: 0;">
                            <div class="input-group" style="width: 100%; display: flex;">
                                <input type="file" class="form-control" id="file-input" accept=".xlsx,.xls" style="flex: 1; min-width: 0;">
                                <button class="btn btn-primary" type="button" onclick="checkFile()" style="flex: 0 0 auto;">ç…§åˆå®Ÿè¡Œ</button>
                            </div>
                            <small class="text-muted d-block" style="margin-top: 0.25rem;">è–¬å±€ã®Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</small>
                        </div>
                        <!-- çµæœè¡¨ç¤º -->
                        <div class="results-area flex-grow-1" style="overflow-y: auto; padding: 0.5rem; margin: 0.5rem;">
                            <div id="results-container">
                                <p class="text-muted">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ã€Œç…§åˆå®Ÿè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä¾›çµ¦æƒ…å ±ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ– -->
                <div class="tab-pane fade" id="content-preview" role="tabpanel" style="overflow: hidden; padding: 0; margin: 0;">
                    <div id="preview-container" class="flex-grow-1" style="display: flex; flex-direction: column; padding: 0; margin: 0; min-height: 0;">
                        <p class="text-muted">ã“ã®ã‚¿ãƒ–ã‚’é–‹ã„ã¦ä¾›çµ¦æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ã¾ã™</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        console.log("index.html loaded");

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let supplyDataCache = null;
        let supplyDataLoaded = false;

        function showStatus(msg, type) {
            console.log("showStatus:", msg, type);
            const statusArea = document.getElementById('status-area');
            const statusMsg = document.getElementById('status-msg');
            statusMsg.className = 'alert alert-' + type + ' mb-3';
            statusMsg.textContent = msg;
            statusArea.style.display = 'block';
        }

        function checkFile() {
            console.log("checkFile called");
            const file = document.getElementById('file-input').files[0];

            if (!file) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            console.log("File selected:", file.name);

            const formData = new FormData();
            formData.append('file', file);

            console.log("Sending POST /check");

            fetch('/check', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log("Response status:", response.status);
                return response.json();
            })
            .then(data => {
                console.log("Response data:", data);

                if (!data.success) {
                    showStatus('ã‚¨ãƒ©ãƒ¼: ' + data.message, 'danger');
                    return;
                }

                showStatus('ãƒãƒƒãƒ: ' + data.stats.matched_rows + 'ä»¶ / 10æ—¥ä»¥å†…: ' + data.stats.recent_updates + 'ä»¶', 'success');
                displayResults(data.data);
            })
            .catch(error => {
                console.error("Fetch error:", error);
                showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'danger');
            });
        }

        function displayResults(data) {
            console.log("displayResults:", data.length, "rows");

            const container = document.getElementById('results-container');

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-warning">è©²å½“ã™ã‚‹åŒ»è–¬å“ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            // Sort data: by date (newest first), then by drug name (alphabetically)
            data.sort((a, b) => {
                // Find date column dynamically
                let dateA = '';
                let dateB = '';
                for (const key in a) {
                    if (key.includes('æ›´æ–°') && key.includes('æ—¥')) {
                        dateA = a[key] || '';
                        break;
                    }
                }
                for (const key in b) {
                    if (key.includes('æ›´æ–°') && key.includes('æ—¥')) {
                        dateB = b[key] || '';
                        break;
                    }
                }

                // Sort by date (newest first)
                if (dateB !== dateA) {
                    return dateB.localeCompare(dateA);
                }

                // If same date, sort by drug name (alphabetically)
                const nameA = (a.pharmacy_è–¬å“å || '').toString();
                const nameB = (b.pharmacy_è–¬å“å || '').toString();
                return nameA.localeCompare(nameB, 'ja');
            });

            let html = '<div class="table-responsive"><table class="table table-sm table-hover">';
            html += '<thead class="table-light"><tr>';
            html += '<th>è–¬å“ã‚³ãƒ¼ãƒ‰</th>';
            html += '<th>æˆåˆ†å</th>';
            html += '<th style="min-width: 150px;">è¦æ ¼</th>';
            html += '<th>ãƒ¡ãƒ¼ã‚«ãƒ¼</th>';
            html += '<th>ä¾›çµ¦çŠ¶æ³</th>';
            html += '<th>æ›´æ–°æ—¥</th>';
            html += '</tr></thead><tbody>';

            data.forEach((row, idx) => {
                console.log("Row " + idx + ":", Object.keys(row));

                const code = (row.pharmacy_è–¬å“ã‚³ãƒ¼ãƒ‰ || '').toString();

                // Find the ingredient name column (â‘¢æˆåˆ†å)
                let ingredient = '';
                for (const key in row) {
                    if (key.includes('æˆåˆ†å')) {
                        ingredient = (row[key] || '').toString();
                        break;
                    }
                }

                // Find the specification column (â‘£è¦æ ¼å˜ä½)
                let spec = '';
                for (const key in row) {
                    if (key.includes('è¦æ ¼')) {
                        spec = (row[key] || '').toString().replace(/\n/g, '<br>');
                        break;
                    }
                }

                // Find the manufacturer column (â‘¦è£½é€ è²©å£²æ¥­è€…å)
                let maker = '';
                for (const key in row) {
                    if (key.includes('è£½é€ è²©å£²æ¥­è€…')) {
                        maker = (row[key] || '').toString();
                        break;
                    }
                }

                // Find the supply status column (look for ä¾›çµ¦çŠ¶æ³ or å‡ºè·å¯¾å¿œ)
                let status = '';
                for (const key in row) {
                    if (key.includes('ä¾›çµ¦çŠ¶æ³') || key.includes('å‡ºè·å¯¾å¿œ')) {
                        status = (row[key] || '').toString();
                        break;
                    }
                }

                let date = '';
                for (const key in row) {
                    if (key.includes('æ›´æ–°') && key.includes('æ—¥')) {
                        date = (row[key] || '').toString();
                        break;
                    }
                }

                html += '<tr>';
                html += '<td><code>' + code + '</code></td>';
                html += '<td>' + ingredient + '</td>';
                html += '<td style="white-space: pre-wrap;">' + spec + '</td>';
                html += '<td>' + maker + '</td>';
                html += '<td>' + status + '</td>';
                html += '<td><strong>' + date + '</strong></td>';
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
            console.log("Results displayed");
        }

        function refreshData() {
            console.log("refreshData called");

            fetch('/refresh', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    console.log("Refresh response:", data);
                    showStatus(data.message, data.success ? 'success' : 'warning');

                    // Update last-updated display
                    if (data.last_checked) {
                        document.getElementById('last-updated').textContent = 'æœ€çµ‚æ›´æ–°: ' + data.last_checked;
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'danger');
                });
        }

        function previewMHLW() {
            console.log("previewMHLW called");

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨
            if (supplyDataCache) {
                console.log("Using cached supply data");
                displayPreview(supplyDataCache);
                return;
            }

            fetch('/preview-supply')
                .then(response => response.json())
                .then(data => {
                    console.log("Preview response:", data);

                    if (!data.success) {
                        showStatus('ã‚¨ãƒ©ãƒ¼: ' + data.message, 'danger');
                        return;
                    }

                    displayPreview(data);
                    // ã‚¿ãƒ–ã‚’è‡ªå‹•çš„ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
                    const previewTab = new bootstrap.Tab(document.getElementById('tab-preview'));
                    previewTab.show();
                })
                .catch(error => {
                    console.error("Error:", error);
                    showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'danger');
                });
        }

        function displayPreview(data) {
            console.log("displayPreview:", data.data.length, "rows");

            const container = document.getElementById('preview-container');
            const cols = data.columns || [];
            const rows = data.data || [];

            let html = '';

            // Container with flex layout
            html += '<div style="display: flex; flex-direction: column; margin: 0; padding: 0; min-height: 0; height: 100%;">';

            // Fixed search box area (does NOT scroll)
            html += '<div style="flex: 0 0 auto; margin: 0; padding: 0.5rem 0.5rem 0 0.5rem;">';
            html += '<div class="alert alert-info" style="margin: 0 0 0.5rem 0; padding: 0.5rem 0.75rem;">';
            html += '<small><strong>åšç”ŸåŠ´åƒçœã®åŒ»è–¬å“ä¾›çµ¦çŠ¶æ³ãƒ‡ãƒ¼ã‚¿</strong>ï¼ˆå…¨ ' + data.total_rows + ' ä»¶ï¼‰</small>';
            html += '</div>';
            html += '<div class="input-group" style="margin-bottom: 0.5rem;">';
            html += '<input type="text" class="form-control" id="supply-search" placeholder="åŒ»è–¬å“åã€æˆåˆ†åã€ãƒ¡ãƒ¼ã‚«ãƒ¼åãªã©ã§æ¤œç´¢..." onkeyup="filterSupplyTable()">';
            html += '<button class="btn btn-outline-secondary" type="button" onclick="clearSupplySearch()">ã‚¯ãƒªã‚¢</button>';
            html += '</div>';
            html += '<small class="text-muted" id="supply-count" style="display: block; margin-bottom: 0;">å…¨ ' + rows.length + ' ä»¶ã‚’è¡¨ç¤ºä¸­</small>';
            html += '</div>';

            // Scrollable table area (table only)
            html += '<div style="flex: 1 1 auto; overflow-y: auto; border: 1px solid #ddd; margin: 0.5rem 0.5rem 0.5rem 0.5rem; min-height: 300px;">';
            html += '<div class="table-responsive" style="margin: 0; min-width: 100%;">';
            html += '<table class="table table-sm table-striped table-hover" id="supply-table" style="margin-bottom: 0; min-width: 100%;">';
            html += '<thead class="table-light" style="position: sticky; top: 0; z-index: 1;"><tr>';

            cols.forEach(col => {
                html += '<th>' + col + '</th>';
            });

            html += '</tr></thead><tbody>';

            rows.forEach((row, idx) => {
                html += '<tr class="supply-row">';
                cols.forEach(col => {
                    const val = (row[col] || '').toString().replace(/\n/g, '<br>');
                    html += '<td style="white-space: pre-wrap;">' + val + '</td>';
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            html += '</div>';
            html += '</div>';  // Close scrollable table area
            html += '</div>';  // Close flex container

            container.innerHTML = html;
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
            supplyDataCache = data;
            supplyDataLoaded = true;
            console.log("Supply data cached");
        }

        function filterSupplyTable() {
            const input = document.getElementById('supply-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('supply-table');
            const rows = table.getElementsByClassName('supply-row');
            let visibleCount = 0;

            for (let i = 0; i < rows.length; i++) {
                const text = rows[i].textContent || rows[i].innerText;
                if (text.toUpperCase().indexOf(filter) > -1) {
                    rows[i].style.display = '';
                    visibleCount++;
                } else {
                    rows[i].style.display = 'none';
                }
            }

            document.getElementById('supply-count').textContent = 'æ¤œç´¢çµæœ: ' + visibleCount + ' ä»¶';
        }

        function clearSupplySearch() {
            document.getElementById('supply-search').value = '';
            filterSupplyTable();
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
        document.getElementById('tab-preview').addEventListener('shown.bs.tab', function() {
            console.log("Preview tab shown");
            // ãƒ‡ãƒ¼ã‚¿ãŒæœªèª­ã¿è¾¼ã¿ã®å ´åˆã®ã¿èª­ã¿è¾¼ã‚€
            if (!supplyDataLoaded) {
                previewMHLW();
            }
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«ç…§åˆã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆã‚‹éš›ã«ã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ç¢ºèª
        document.getElementById('tab-check').addEventListener('shown.bs.tab', function() {
            console.log("File check tab shown");
            const contentCheck = document.getElementById('content-check');
            if (contentCheck) {
                void contentCheck.offsetHeight;
            }
        });

        console.log("All functions ready");
    </script>
</body>
</html>
