<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è–¬å±€å‘ã‘åŒ»è–¬å“ä¾›çµ¦çŠ¶æ³ãƒã‚§ãƒƒã‚«ãƒ¼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        body { display: flex; flex-direction: column; }
        .main-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .results-area { flex: 1; overflow-y: auto; }
        /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã® flex è¨­å®š */
        .tab-content { display: flex !important; flex-direction: column; height: 100%; width: 100%; }
        /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ãƒšã‚¤ãƒ³ã¯ flex ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä¿æŒ */
        .tab-pane {
            overflow: visible;
            height: 100% !important;
            width: 100% !important;
            display: none !important;
            flex-direction: column;
        }
        .tab-pane.active {
            display: flex !important;
            flex-direction: column;
            height: 100% !important;
            width: 100% !important;
        }
    </style>
</head>
<body>
    <div class="main-container p-3">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">è–¬å±€å‘ã‘åŒ»è–¬å“ä¾›çµ¦çŠ¶æ³ãƒã‚§ãƒƒã‚«ãƒ¼</h1>
                <div class="d-flex gap-2 align-items-center">
                    <small class="text-muted" id="last-updated">{% if status.last_checked %}æœ€çµ‚æ›´æ–°: {{ status.last_checked.split('T')[0] }}{% if status.file_date %}ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«: {{ status.file_date }}ï¼‰{% endif %}{% else %}æœªæ›´æ–°{% endif %}</small>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshData()" title="åšç”ŸåŠ´åƒçœã®æœ€æ–°ã®åŒ»è–¬å“ä¾›çµ¦æƒ…å ±ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦æ›´æ–°">
                        ğŸ”„ åšåŠ´çœãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                    </button>
                </div>
            </div>
        </div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
        <div id="status-area" style="display: none;">
            <div class="alert mb-3" id="status-msg"></div>
        </div>

        <!-- ã‚¿ãƒ–UI -->
        <div class="card flex-grow-1" style="overflow: hidden; display: flex; flex-direction: column;">
            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="card-header" style="padding: 0;">
                <ul class="nav nav-tabs" role="tablist" style="border-bottom: none; margin-bottom: 0;">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-check" data-bs-toggle="tab" data-bs-target="#content-check" type="button" role="tab">
                            ğŸ“‹ ãƒ•ã‚¡ã‚¤ãƒ«ç…§åˆ
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-preview" data-bs-toggle="tab" data-bs-target="#content-preview" type="button" role="tab">
                            ğŸ“„ ä¾›çµ¦æƒ…å ±ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                        </button>
                    </li>
                </ul>
            </div>

            <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div class="tab-content flex-grow-1" style="overflow: hidden;">
                <!-- ãƒ•ã‚¡ã‚¤ãƒ«ç…§åˆã‚¿ãƒ– -->
                <div class="tab-pane fade show active" id="content-check" role="tabpanel" style="overflow: hidden; padding: 0; margin: 0;">
                    <div class="card-body" style="display: flex; flex-direction: column; overflow: hidden; padding: 0; margin: 0; min-height: 0;">
                        <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ -->
                        <div style="padding: 0.5rem; flex: 0 0 auto; margin: 0;">
                            <div class="input-group" style="width: 100%; display: flex;">
                                <input type="file" class="form-control" id="file-input" accept=".xlsx,.xls" style="flex: 1; min-width: 0;">
                                <button class="btn btn-primary" type="button" onclick="checkFile()" style="flex: 0 0 auto;">ç…§åˆå®Ÿè¡Œ</button>
                            </div>
                            <small class="text-muted d-block" style="margin-top: 0.25rem;">è–¬å±€ã®Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</small>
                        </div>
                        <!-- çµæœè¡¨ç¤º -->
                        <div class="results-area flex-grow-1" style="overflow-y: auto; padding: 0.5rem; margin: 0.5rem;">
                            <div id="results-container">
                                <p class="text-muted">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ã€Œç…§åˆå®Ÿè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä¾›çµ¦æƒ…å ±ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ– -->
                <div class="tab-pane fade" id="content-preview" role="tabpanel" style="overflow: hidden; padding: 0; margin: 0;">
                    <div id="preview-container" class="flex-grow-1" style="display: flex; flex-direction: column; padding: 0; margin: 0; min-height: 0;">
                        <p class="text-muted">ã“ã®ã‚¿ãƒ–ã‚’é–‹ã„ã¦ä¾›çµ¦æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ã¾ã™</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        console.log("index.html loaded");
        const MAX_UPLOAD_MB = {{ max_upload_mb|default(5) }};
        const MAX_UPLOAD_BYTES = MAX_UPLOAD_MB * 1024 * 1024;
        const ASYNC_THRESHOLD_MB = 0;
        const ASYNC_THRESHOLD_BYTES = ASYNC_THRESHOLD_MB * 1024 * 1024;
        const MAX_PROCESS_SECONDS = {{ max_process_seconds|default(300) }};

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let supplyDataCache = null;
        let supplyDataLoaded = false;
        let supplySearchTimer = null;
        let supplySearchMode = 'preview';

        function showStatus(msg, type) {
            console.log("showStatus:", msg, type);
            const statusArea = document.getElementById('status-area');
            const statusMsg = document.getElementById('status-msg');
            statusMsg.className = 'alert alert-' + type + ' mb-3';
            statusMsg.textContent = msg;
            statusArea.style.display = 'block';
        }

        function checkFile() {
            console.log("checkFile called");
            const file = document.getElementById('file-input').files[0];

            if (!file) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (file.size > MAX_UPLOAD_BYTES) {
                showStatus('ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆä¸Šé™ ' + MAX_UPLOAD_MB + 'MBï¼‰', 'danger');
                const container = document.getElementById('results-container');
                container.innerHTML = '<p class="text-danger">ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆä¸Šé™ ' + MAX_UPLOAD_MB + 'MBï¼‰</p>';
                return;
            }

            console.log("File selected:", file.name);

            // Show loading indicator immediately
            const container = document.getElementById('results-container');
            container.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">å‡¦ç†ä¸­...</span></div><p class="mt-3">ğŸ“¤ ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ' + file.name + 'ã€ã‚’ç…§åˆä¸­ã§ã™...ï¼ˆæ•°ç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰</p></div>';

            // Disable button
            const checkBtn = document.querySelector('button[onclick="checkFile()"]');
            if (checkBtn) {
                checkBtn.disabled = true;
                checkBtn.textContent = 'å‡¦ç†ä¸­...';
            }

            showStatus('ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­ã§ã™...ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒã«ã‚ˆã£ã¦ã¯æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰', 'info');

            const formData = new FormData();
            formData.append('file', file);

            console.log("Sending POST /check");

            const useAsync = file.size >= ASYNC_THRESHOLD_BYTES;
            if (useAsync) {
                showStatus('â³ å¤§ãã‚ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ãŸã‚éåŒæœŸå‡¦ç†ã§å®Ÿè¡Œã—ã¾ã™', 'info');
                fetch('/check_async', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        showStatus('ã‚¨ãƒ©ãƒ¼: ' + data.message, 'danger');
                        container.innerHTML = '<p class="text-danger">ã‚¨ãƒ©ãƒ¼: ' + data.message + '</p>';
                        if (checkBtn) {
                            checkBtn.disabled = false;
                            checkBtn.textContent = 'ç…§åˆå®Ÿè¡Œ';
                        }
                        return;
                    }
                    pollJobStatus(data.job_id, container, checkBtn);
                })
                .catch(error => {
                    showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'danger');
                    container.innerHTML = '<p class="text-danger">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
                    if (checkBtn) {
                        checkBtn.disabled = false;
                        checkBtn.textContent = 'ç…§åˆå®Ÿè¡Œ';
                    }
                });
                return;
            }

            const controller = new AbortController();
            const timeoutMs = MAX_PROCESS_SECONDS * 1000;
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

            fetch('/check', {
                method: 'POST',
                body: formData,
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                console.log("Response status:", response.status);
                return response.json();
            })
            .then(data => {
                console.log("Response data:", data);

                // Re-enable button
                if (checkBtn) {
                    checkBtn.disabled = false;
                    checkBtn.textContent = 'ç…§åˆå®Ÿè¡Œ';
                }

                if (!data.success) {
                    showStatus('ã‚¨ãƒ©ãƒ¼: ' + data.message, 'danger');
                    container.innerHTML = '<p class="text-danger">ã‚¨ãƒ©ãƒ¼: ' + data.message + '</p>';
                    return;
                }

                showStatus('âœ… ãƒãƒƒãƒ: ' + data.stats.matched_rows + 'ä»¶ / 10æ—¥ä»¥å†…: ' + data.stats.recent_updates + 'ä»¶', 'success');
                displayResults(data.data);
            })
            .catch(error => {
                console.error("Fetch error:", error);
                if (error.name === 'AbortError') {
                    showStatus('ã‚¨ãƒ©ãƒ¼: å‡¦ç†ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆ' + (timeoutMs / 1000) + 'ç§’ï¼‰', 'danger');
                    container.innerHTML = '<p class="text-danger">ã‚¨ãƒ©ãƒ¼: å‡¦ç†ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆ' + (timeoutMs / 1000) + 'ç§’ï¼‰</p>';
                } else {
                showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'danger');
                container.innerHTML = '<p class="text-danger">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
                }

                // Re-enable button
                if (checkBtn) {
                    checkBtn.disabled = false;
                    checkBtn.textContent = 'ç…§åˆå®Ÿè¡Œ';
                }
            });
        }

        function pollJobStatus(jobId, container, checkBtn) {
            const intervalMs = 2000;
            const poll = () => {
                fetch('/check_status/' + jobId)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'running') {
                        setTimeout(poll, intervalMs);
                        return;
                    }
                    if (!data.success) {
                        showStatus('ã‚¨ãƒ©ãƒ¼: ' + data.message, 'danger');
                        container.innerHTML = '<p class="text-danger">ã‚¨ãƒ©ãƒ¼: ' + data.message + '</p>';
                        if (checkBtn) {
                            checkBtn.disabled = false;
                            checkBtn.textContent = 'ç…§åˆå®Ÿè¡Œ';
                        }
                        return;
                    }
                    showStatus('âœ… ãƒãƒƒãƒ: ' + data.stats.matched_rows + 'ä»¶ / 10æ—¥ä»¥å†…: ' + data.stats.recent_updates + 'ä»¶', 'success');
                    displayResults(data.data);
                    if (checkBtn) {
                        checkBtn.disabled = false;
                        checkBtn.textContent = 'ç…§åˆå®Ÿè¡Œ';
                    }
                })
                .catch(error => {
                    showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'danger');
                    container.innerHTML = '<p class="text-danger">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
                    if (checkBtn) {
                        checkBtn.disabled = false;
                        checkBtn.textContent = 'ç…§åˆå®Ÿè¡Œ';
                    }
                });
            };
            poll();
        }

        function displayResults(data) {
            console.log("displayResults:", data.length, "rows");

            const container = document.getElementById('results-container');

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-warning">è©²å½“ã™ã‚‹åŒ»è–¬å“ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            // Enforce date-desc + name-asc order using server-provided sort key
            const parseSortDate = (s) => {
                if (!s) return 0;
                const m = s.toString().match(/(\d{4})[-/](\d{1,2})[-/](\d{1,2})/);
                if (!m) return 0;
                const y = Number(m[1]);
                const mo = Number(m[2]);
                const d = Number(m[3]);
                if (!y) return 0;
                return new Date(y, mo - 1, d).getTime();
            };

            data.sort((a, b) => {
                const dateA = parseSortDate(a._sort_update_date || '');
                const dateB = parseSortDate(b._sort_update_date || '');
                if (dateB !== dateA) return dateB - dateA;
                const nameA = (a.mhlw_â‘¥å“å || a.pharmacy_è–¬å“å || '').toString();
                const nameB = (b.mhlw_â‘¥å“å || b.pharmacy_è–¬å“å || '').toString();
                return nameA.localeCompare(nameB, 'ja');
            });

            let html = '<div class="table-responsive"><table class="table table-sm table-hover">';
            html += '<thead class="table-light"><tr>';
            html += '<th>è–¬å“ã‚³ãƒ¼ãƒ‰</th>';
            html += '<th>åŒ»è–¬å“å</th>';
            html += '<th style="min-width: 150px;">è¦æ ¼</th>';
            html += '<th>ãƒ¡ãƒ¼ã‚«ãƒ¼</th>';
            html += '<th>å‡ºè·å¯¾å¿œ</th>';
            html += '<th>å‡ºè·é‡</th>';
            html += '<th>æ›´æ–°æ—¥</th>';
            html += '</tr></thead><tbody>';

            data.forEach((row, idx) => {
                console.log("Row " + idx + ":", Object.keys(row));

                // Find the drug code column
                // Priority: mhlw_â‘¤YJã‚³ãƒ¼ãƒ‰ > pharmacy_è–¬å“ã‚³ãƒ¼ãƒ‰
                let code = '';

                // First, try to find mhlw code
                for (const key in row) {
                    if (key.startsWith('mhlw_') && (key.includes('ã‚³ãƒ¼ãƒ‰') || key.includes('YJã‚³ãƒ¼ãƒ‰'))) {
                        const value = (row[key] || '').toString().trim();
                        if (value) {
                            code = value;
                            break;
                        }
                    }
                }

                // If not found, try pharmacy code
                if (!code) {
                    code = (row.pharmacy_è–¬å“ã‚³ãƒ¼ãƒ‰ || '').toString().trim();
                }

                // Find the drug name column (â‘¥å“å)
                // Priority: mhlw_â‘¥å“å > pharmacy_è–¬å“å
                let drugName = '';

                // First, try to find mhlw brand name
                for (const key in row) {
                    if (key.startsWith('mhlw_') && key.includes('å“å') && !key.includes('æˆåˆ†å')) {
                        const value = (row[key] || '').toString().trim();
                        if (value) {
                            drugName = value;
                            break;
                        }
                    }
                }

                // If not found, try pharmacy brand name
                if (!drugName) {
                    const pharmName = (row.pharmacy_è–¬å“å || '').toString().trim();
                    if (pharmName) {
                        drugName = pharmName;
                    }
                }

                // Find the specification column (â‘£è¦æ ¼å˜ä½)
                let spec = '';
                for (const key in row) {
                    if (key.includes('è¦æ ¼')) {
                        spec = (row[key] || '').toString().replace(/\n/g, '<br>');
                        break;
                    }
                }

                // Find the manufacturer column (â‘¦è£½é€ è²©å£²æ¥­è€…å)
                let maker = '';
                for (const key in row) {
                    if (key.includes('è£½é€ è²©å£²æ¥­è€…')) {
                        maker = (row[key] || '').toString();
                        break;
                    }
                }

                // Find the shipment status column (â‘«å‡ºè·å¯¾å¿œ)
                let shipmentStatus = '';
                for (const key in row) {
                    if (key.includes('â‘«') || (key.includes('å‡ºè·å¯¾å¿œ') && !key.includes('å‡ºè·é‡'))) {
                        const value = (row[key] || '').toString().trim();
                        if (value) {
                            shipmentStatus = value;
                            break;
                        }
                    }
                }

                // Find the shipment volume column (â‘°å‡ºè·é‡)
                let shipmentVolume = '';
                for (const key in row) {
                    if (key.includes('â‘°') || (key.includes('å‡ºè·é‡') && key.includes('ç¾åœ¨ã®çŠ¶æ³'))) {
                        const value = (row[key] || '').toString().trim();
                        if (value) {
                            shipmentVolume = value;
                            break;
                        }
                    }
                }

                // Find the update date column (â‘³å½“è©²å“ç›®ã®â‘«ä»¥å¤–ã®æƒ…å ±ã‚’æ›´æ–°ã—ãŸæ—¥)
                // Priority: mhlw_â‘³ (other information) > mhlw_â‘¬ (shipment info) > others
                let date = '';

                // First, try to find mhlw_â‘³ (â‘«ä»¥å¤–ã®æƒ…å ±ã‚’æ›´æ–°ã—ãŸæ—¥)
                for (const key in row) {
                    if (key.startsWith('mhlw_') && key.includes('â‘«ä»¥å¤–')) {
                        const value = (row[key] || '').toString().trim();
                        if (value) {
                            date = value;
                            break;
                        }
                    }
                }

                // If not found, try mhlw_â‘¬ (â‘«ã®æƒ…å ±ã‚’æ›´æ–°ã—ãŸæ—¥)
                if (!date) {
                    for (const key in row) {
                        if (key.startsWith('mhlw_') && key.includes('â‘«ã®æƒ…å ±') && key.includes('æ›´æ–°')) {
                            const value = (row[key] || '').toString().trim();
                            if (value) {
                                date = value;
                                break;
                            }
                        }
                    }
                }

                // If not found, try any mhlw key with æ›´æ–°æ—¥
                if (!date) {
                    for (const key in row) {
                        if (key.startsWith('mhlw_') && key.includes('æ›´æ–°') && key.includes('æ—¥')) {
                            const value = (row[key] || '').toString().trim();
                            if (value) {
                                date = value;
                                break;
                            }
                        }
                    }
                }

                html += '<tr>';
                html += '<td><code>' + code + '</code></td>';
                html += '<td>' + drugName + '</td>';
                html += '<td style="white-space: pre-wrap;">' + spec + '</td>';
                html += '<td>' + maker + '</td>';
                html += '<td>' + shipmentStatus + '</td>';
                html += '<td>' + shipmentVolume + '</td>';
                html += '<td><strong>' + date + '</strong></td>';
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
            console.log("Results displayed");
        }

        function refreshData() {
            console.log("refreshData called");

            // Show immediate feedback
            showStatus('ğŸ”„ æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸ...', 'info');

            // Disable button temporarily
            const refreshBtn = document.querySelector('button[onclick="refreshData()"]');
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'æ›´æ–°ä¸­...';
            }

            fetch('/refresh', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    console.log("Refresh response:", data);

                    // æ›´æ–°ã¯è‡ªå‹•å®Ÿè¡Œã€‚ç¢ºèªçµæœã®ã¿å³æ™‚è¡¨ç¤º
                    showStatus('âœ… ' + data.message, 'success');
                    updateLastCheckedDisplay(data);
                    reenableRefreshButton();

                    // è‡ªå‹•æ›´æ–°ã®ãŸã‚ãƒãƒ¼ãƒªãƒ³ã‚°ã¯ä¸è¦
                })
                .catch(error => {
                    console.error("Error:", error);
                    showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'danger');
                    reenableRefreshButton();
                });
        }

        function reenableRefreshButton() {
            const refreshBtn = document.querySelector('button[onclick="refreshData()"]');
            if (refreshBtn) {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'ğŸ”„ åšåŠ´çœãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°';
            }
        }

        function updateLastCheckedDisplay(data) {
            // Update last-updated display
            if (data.last_checked) {
                let statusText = 'æœ€çµ‚æ›´æ–°: ' + data.last_checked;
                if (data.file_date) {
                    statusText += 'ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«: ' + data.file_date + 'ï¼‰';
                }
                if (data.checked_at) {
                    const checkDate = data.checked_at.split('T')[0];
                    statusText += ' / æœ€çµ‚ç¢ºèª: ' + checkDate;
                }
                document.getElementById('last-updated').textContent = statusText;
            }
        }

        let pollCount = 0;
        const MAX_POLL_COUNT = 120;  // Max 240 seconds of polling (120 x 2sec)

        function pollRefreshStatus() {
            pollCount++;
            const elapsedSeconds = pollCount * 2;

            // Poll for status update every 2 seconds
            setTimeout(() => {
                fetch('/refresh-status')
                    .then(response => response.json())
                    .then(data => {
                        console.log("Status poll:", data, "elapsed:", elapsedSeconds + "s");

                        if (data.last_refresh_error) {
                            showStatus('âŒ æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.last_refresh_error, 'danger');
                            reenableRefreshButton();
                            pollCount = 0;
                            return;
                        }

                        if (!data.refresh_in_progress) {
                            // Update completed (success or no change)
                            showStatus('âœ… æ›´æ–°å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚', 'success');
                            updateLastCheckedDisplay({
                                last_checked: data.last_checked
                                    ? data.last_checked.split('T')[0]
                                    : new Date().toISOString().split('T')[0],
                                file_date: data.file_date || ''
                            });
                            reenableRefreshButton();
                            pollCount = 0;
                            return;
                        }

                        // Continue polling
                        if (pollCount < MAX_POLL_COUNT) {
                            const secondsLeft = (MAX_POLL_COUNT - pollCount) * 2;
                            showStatus(`ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­ã§ã™...ï¼ˆ${elapsedSeconds}ç§’çµŒéã€ã‚ã¨${secondsLeft}ç§’ã¾ã§å¾…æ©Ÿï¼‰`, 'info');
                            pollRefreshStatus();
                        } else {
                            // Timeout - but update might still be in progress
                            showStatus('â³ æ›´æ–°å‡¦ç†ãŒæ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚ï¼ˆæ›´æ–°ãŒé€²è¡Œä¸­ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰', 'warning');
                            reenableRefreshButton();
                            pollCount = 0;
                        }
                    })
                    .catch(error => {
                        console.error("Poll error:", error);
                        if (pollCount < MAX_POLL_COUNT) {
                            pollRefreshStatus();
                        } else {
                            showStatus('â³ æ›´æ–°å‡¦ç†ãŒæ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'warning');
                            reenableRefreshButton();
                            pollCount = 0;
                        }
                    });
            }, 2000);  // Poll every 2 seconds
        }

        function extractDateFromUrl(url) {
            try {
                // Extract filename from URL
                const filename = url.split('/').pop();

                // Find first 6 consecutive digits at the start of filename
                const match = filename.match(/^(\d{6})/);
                if (match) {
                    const dateStr = match[1];
                    const year = 2000 + parseInt(dateStr.substring(0, 2));
                    const month = dateStr.substring(2, 4);
                    const day = dateStr.substring(4, 6);
                    return `${year}-${month}-${day}`;
                }
            } catch (e) {
                console.error("Error extracting date:", e);
            }
            return '';
        }

        let supplyDataLoadOffset = 0;  // Track pagination offset
        let supplyDataTotalRows = 0;   // Track total available rows

        function previewMHLW() {
            console.log("previewMHLW called");

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨
            if (supplyDataCache) {
                console.log("Using cached supply data");
                displayPreview(supplyDataCache);
                return;
            }

            // Show loading indicator
            const container = document.getElementById('preview-container');
            container.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span></div><p class="mt-3">ä¾›çµ¦æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p></div>';

            // Load initial batch (limit=20 for faster initial display)
            supplyDataLoadOffset = 0;
            loadSupplyDataBatch(0, 20);
        }

        function loadSupplyDataBatch(offset, limit) {
            fetch(`/preview-supply?limit=${limit}&offset=${offset}`)
                .then(response => response.json())
                .then(data => {
                    console.log("Preview response:", data);

                    if (!data.success) {
                        showStatus('ã‚¨ãƒ©ãƒ¼: ' + data.message, 'danger');
                        return;
                    }

                    // First batch: initialize cache and display
                    if (offset === 0) {
                        supplyDataCache = { ...data };
                        supplyDataTotalRows = data.total_rows;
                        supplyDataLoadOffset = limit;
                        displayPreview(supplyDataCache);
                    } else {
                        // Additional batches: append to existing data
                        supplyDataCache.data = supplyDataCache.data.concat(data.data);
                        supplyDataLoadOffset = offset + limit;
                        appendPreviewRows(data.data);
                        updateLoadMoreButton();
                    }

                    // ã‚¿ãƒ–ã‚’è‡ªå‹•çš„ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼ˆåˆå›ã®ã¿ï¼‰
                    if (offset === 0) {
                        const previewTab = new bootstrap.Tab(document.getElementById('tab-preview'));
                        previewTab.show();
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'danger');
                });
        }

        function loadMoreSupplyData() {
            console.log("Loading more data from offset:", supplyDataLoadOffset);

            // Disable and update button
            const loadMoreBtn = document.getElementById('load-more-btn');
            if (loadMoreBtn) {
                loadMoreBtn.disabled = true;
                loadMoreBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>èª­ã¿è¾¼ã¿ä¸­...';
            }

            loadSupplyDataBatch(supplyDataLoadOffset, 20);
        }

        function displayPreview(data) {
            console.log("displayPreview:", data.data.length, "rows");

            const container = document.getElementById('preview-container');
            const cols = data.columns || [];
            const rows = data.data || [];

            let html = '';

            // Container with flex layout
            html += '<div style="display: flex; flex-direction: column; margin: 0; padding: 0; min-height: 0; height: 100%;">';

            // Fixed search box area (does NOT scroll)
            html += '<div style="flex: 0 0 auto; margin: 0; padding: 0.5rem 0.5rem 0 0.5rem;">';
            html += '<div class="alert alert-info" style="margin: 0 0 0.5rem 0; padding: 0.5rem 0.75rem;">';
            html += '<small><strong>åšç”ŸåŠ´åƒçœã®åŒ»è–¬å“ä¾›çµ¦çŠ¶æ³ãƒ‡ãƒ¼ã‚¿</strong>ï¼ˆå…¨ ' + data.total_rows + ' ä»¶ï¼‰</small>';
            html += '</div>';
            html += '<div class="input-group" style="margin-bottom: 0.5rem;">';
            html += '<input type="text" class="form-control" id="supply-search" placeholder="åŒ»è–¬å“åã€æˆåˆ†åã€ãƒ¡ãƒ¼ã‚«ãƒ¼åãªã©ã§æ¤œç´¢...">';
            html += '<button class="btn btn-primary" type="button" onclick="runSupplySearch()">æ¤œç´¢</button>';
            html += '<button class="btn btn-outline-secondary" type="button" onclick="clearSupplySearch()">ã‚¯ãƒªã‚¢</button>';
            html += '</div>';
            html += '<small class="text-muted" id="supply-count" style="display: block; margin-bottom: 0;">è¡¨ç¤ºä¸­: ' + rows.length + ' ä»¶ / å…¨ ' + data.total_rows + ' ä»¶</small>';
            html += '</div>';

            // Scrollable table area (table only)
            html += '<div style="flex: 1 1 auto; overflow-y: auto; border: 1px solid #ddd; margin: 0.5rem 0.5rem 0.5rem 0.5rem; min-height: 300px;">';
            html += '<div class="table-responsive" style="margin: 0; min-width: 100%;">';
            html += '<table class="table table-sm table-striped table-hover" id="supply-table" style="margin-bottom: 0; min-width: 100%;">';
            html += '<thead class="table-light" style="position: sticky; top: 0; z-index: 1;"><tr>';

            cols.forEach(col => {
                html += '<th>' + col + '</th>';
            });

            html += '</tr></thead><tbody id="supply-table-body"></tbody></table>';
            html += '</div>';
            html += '</div>';  // Close scrollable table area

            // Load more button area
            if (rows.length < data.total_rows) {
                html += '<div id="load-more-container" style="flex: 0 0 auto; padding: 0.5rem; text-align: center; border-top: 1px solid #ddd;">';
                html += '<button class="btn btn-sm btn-outline-primary" onclick="loadMoreSupplyData()" id="load-more-btn">ã•ã‚‰ã«èª­ã¿è¾¼ã‚€ï¼ˆ' + (data.total_rows - rows.length) + ' ä»¶æ®‹ã‚Šï¼‰</button>';
                html += '</div>';
            }

            html += '</div>';  // Close flex container

            container.innerHTML = html;

            // Append rows efficiently using DocumentFragment
            const tbody = document.getElementById('supply-table-body');
            const fragment = document.createDocumentFragment();

            rows.forEach((row, idx) => {
                const tr = document.createElement('tr');
                tr.className = 'supply-row';
                cols.forEach(col => {
                    const td = document.createElement('td');
                    td.style.whiteSpace = 'pre-wrap';
                    const val = (row[col] || '').toString().replace(/\n/g, '<br>');
                    td.innerHTML = val;
                    tr.appendChild(td);
                });
                fragment.appendChild(tr);
            });

            tbody.appendChild(fragment);

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
            supplyDataCache = data;
            supplyDataLoaded = true;
            console.log("Supply data cached");
        }

        function appendPreviewRows(newRows) {
            const tbody = document.getElementById('supply-table-body');
            const cols = supplyDataCache.columns || [];
            const fragment = document.createDocumentFragment();

            newRows.forEach((row, idx) => {
                const tr = document.createElement('tr');
                tr.className = 'supply-row';
                cols.forEach(col => {
                    const td = document.createElement('td');
                    td.style.whiteSpace = 'pre-wrap';
                    const val = (row[col] || '').toString().replace(/\n/g, '<br>');
                    td.innerHTML = val;
                    tr.appendChild(td);
                });
                fragment.appendChild(tr);
            });

            tbody.appendChild(fragment);
        }

        function updateLoadMoreButton() {
            const remaining = supplyDataTotalRows - supplyDataLoadOffset;
            const container = document.getElementById('load-more-container');

            if (remaining <= 0) {
                if (container) container.remove();
            } else {
                const btn = document.getElementById('load-more-btn');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'ã•ã‚‰ã«èª­ã¿è¾¼ã‚€ï¼ˆ' + remaining + ' ä»¶æ®‹ã‚Šï¼‰';
                }
            }

            // Update count display
            const countDisplay = document.getElementById('supply-count');
            if (countDisplay) {
                countDisplay.textContent = 'è¡¨ç¤ºä¸­: ' + supplyDataLoadOffset + ' ä»¶ / å…¨ ' + supplyDataTotalRows + ' ä»¶';
            }
        }

        function filterSupplyTable() {
            // No-op: keep for backward compatibility if referenced elsewhere
            return;
        }

        function runSupplySearch() {
            const input = document.getElementById('supply-search');
            if (!input) return;
            const query = input.value.trim();
            if (!query) {
                supplySearchMode = 'preview';
                supplyDataLoaded = false;
                previewMHLW();
                return;
            }
            if (supplySearchTimer) {
                clearTimeout(supplySearchTimer);
            }
            supplySearchMode = 'search';
            showStatus('ğŸ” æ¤œç´¢ä¸­ã§ã™...ï¼ˆæ•°ç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰', 'info');
            searchSupplyData(query);
        }

        function searchSupplyData(searchQuery) {
            console.log("Searching for:", searchQuery);

            fetch(`/preview-supply?search=${encodeURIComponent(searchQuery)}&limit=99999&offset=0`)
                .then(response => response.json())
                .then(data => {
                    console.log("Search response:", data);

                    if (!data.success) {
                        showStatus('æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ' + data.message, 'danger');
                        return;
                    }

                    // Display search results
                    displaySearchResults(data);
                })
                .catch(error => {
                    console.error("Search error:", error);
                    showStatus('æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ' + error.message, 'danger');
                });
        }

        function displaySearchResults(data) {
            const container = document.getElementById('preview-container');
            const cols = data.columns || [];
            const rows = data.data || [];

            let html = '';

            // Container with flex layout
            html += '<div style="display: flex; flex-direction: column; margin: 0; padding: 0; min-height: 0; height: 100%;">';

            // Fixed search box area
            html += '<div style="flex: 0 0 auto; margin: 0; padding: 0.5rem 0.5rem 0 0.5rem;">';
            html += '<div class="alert alert-info" style="margin: 0 0 0.5rem 0; padding: 0.5rem 0.75rem;">';
            html += '<small><strong>æ¤œç´¢çµæœ</strong>ï¼ˆå…¨ ' + data.total_rows + ' ä»¶ï¼‰</small>';
            html += '</div>';
            html += '<div class="input-group" style="margin-bottom: 0.5rem;">';
            html += '<input type="text" class="form-control" id="supply-search" placeholder="åŒ»è–¬å“åã€æˆåˆ†åã€ãƒ¡ãƒ¼ã‚«ãƒ¼åãªã©ã§æ¤œç´¢...">';
            html += '<button class="btn btn-primary" type="button" onclick="runSupplySearch()">æ¤œç´¢</button>';
            html += '<button class="btn btn-outline-secondary" type="button" onclick="clearSupplySearch()">ã‚¯ãƒªã‚¢</button>';
            html += '</div>';
            html += '<small class="text-muted" id="supply-count" style="display: block; margin-bottom: 0;">æ¤œç´¢çµæœ: ' + rows.length + ' ä»¶</small>';
            html += '</div>';

            // Scrollable table area
            html += '<div style="flex: 1 1 auto; overflow-y: auto; border: 1px solid #ddd; margin: 0.5rem 0.5rem 0.5rem 0.5rem; min-height: 300px;">';
            html += '<div class="table-responsive" style="margin: 0; min-width: 100%;">';
            html += '<table class="table table-sm table-striped table-hover" id="supply-table" style="margin-bottom: 0; min-width: 100%;">';
            html += '<thead class="table-light" style="position: sticky; top: 0; z-index: 1;"><tr>';

            cols.forEach(col => {
                html += '<th>' + col + '</th>';
            });

            html += '</tr></thead><tbody id="supply-table-body"></tbody></table>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            container.innerHTML = html;

            // Append rows using DocumentFragment
            const tbody = document.getElementById('supply-table-body');
            const fragment = document.createDocumentFragment();

            rows.forEach((row, idx) => {
                const tr = document.createElement('tr');
                tr.className = 'supply-row';
                cols.forEach(col => {
                    const td = document.createElement('td');
                    td.style.whiteSpace = 'pre-wrap';
                    const val = (row[col] || '').toString().replace(/\n/g, '<br>');
                    td.innerHTML = val;
                    tr.appendChild(td);
                });
                fragment.appendChild(tr);
            });

            tbody.appendChild(fragment);

            // Restore search value
            document.getElementById('supply-search').value = document.getElementById('supply-search').value || '';
        }

        function clearSupplySearch() {
            document.getElementById('supply-search').value = '';
            supplyDataLoaded = false;
            previewMHLW();
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
        document.getElementById('tab-preview').addEventListener('shown.bs.tab', function() {
            console.log("Preview tab shown");
            // ãƒ‡ãƒ¼ã‚¿ãŒæœªèª­ã¿è¾¼ã¿ã®å ´åˆã®ã¿èª­ã¿è¾¼ã‚€
            if (!supplyDataLoaded) {
                previewMHLW();
            }
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«ç…§åˆã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆã‚‹éš›ã«ã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ç¢ºèª
        document.getElementById('tab-check').addEventListener('shown.bs.tab', function() {
            console.log("File check tab shown");
            const contentCheck = document.getElementById('content-check');
            if (contentCheck) {
                void contentCheck.offsetHeight;
            }
        });

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®è‡ªå‹•èª­ã¿è¾¼ã¿ã¯å‰Šé™¤ï¼ˆã‚¿ãƒ–ã‚¯ãƒªãƒƒã‚¯æ™‚ã«èª­ã¿è¾¼ã‚€ï¼‰
        console.log("All functions ready");
    </script>
</body>
</html>
