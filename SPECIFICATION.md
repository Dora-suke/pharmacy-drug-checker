# 薬局向け医薬品供給状況チェッカー - 仕様書

**バージョン:** 1.0
**更新日:** 2026-02-08
**ステータス:** 本番運用中

---

## 1. アプリケーション概要

### 1.1 目的
薬局が保有する医薬品在庫リストを、厚生労働省（MHLW）の医薬品供給状況データと照合し、供給状況が最新の医薬品を簡単に確認できるツール。

### 1.2 主な特徴
- **ファイル照合機能**: 薬局のExcelファイルと厚労省データの自動マッチング
- **供給情報プレビュー**: 厚労省データベースの閲覧・検索
- **リアルタイム更新**: 厚労省の最新データを自動ダウンロード
- **インテリジェント照合**: 薬品コードと薬品名の複数パターン対応
- **データキャッシング**: 高速なタブ切り替え

---

## 2. 機能仕様

### 2.1 ファイル照合タブ（📋 ファイル照合）

#### 2.1.1 ファイル選択
- **入力形式**: Excel ファイル（.xlsx, .xls）
- **選択方法**: ファイルピッカーで選択
- **実行ボタン**: 「照合実行」クリックで処理開始

#### 2.1.2 照合ロジック
1. **薬品コード列の検出**
   - 20+ の列名パターンを検索
   - パターン例: 「コード」「医薬品コード」「YJコード」など
   - マッチ: 先にマッチした列を使用

2. **薬品名列の検出**
   - 25+ の列名パターンを検索
   - パターン例: 「薬品名」「品名」「製品名」「成分名」など
   - マッチ: 先にマッチした列を使用

3. **マッチング処理**
   - 厚労省データベースと照合
   - 完全一致検索
   - マッチした医薬品のすべての情報を結果に含む

#### 2.1.3 結果表示
- **テーブル形式で表示**:
  - 薬品コード
  - 成分名
  - 規格（複数行対応）
  - メーカー
  - 供給状況
  - 更新日

- **ソート順序**:
  1. 更新日（新しい順）
  2. 薬品名（あいうえお順）

- **統計情報**:
  - マッチ件数
  - 10日以内の更新件数

#### 2.1.4 ユーザーフィードバック
- 成功時: 緑色アラート + マッチ統計
- エラー時: 赤色アラート + エラーメッセージ

---

### 2.2 供給情報プレビュータブ（📄 供給情報プレビュー）

#### 2.2.1 データ表示
- **全件数表示**: 「厚生労働省の医薬品供給状況データ（全 XXXXX 件）」
- **テーブル形式**: 厚労省データベースの全列を表示
- **白スペース対応**: 改行を `<br>` に変換して表示
- **スクロール対応**: 表が大量データでも水平・垂直スクロール可能

#### 2.2.2 検索機能
- **リアルタイム検索ボックス**: 医薬品名、成分名、メーカー名で検索
- **複数カラム対応**: すべてのカラムをテキスト検索
- **大文字小文字区別なし**: 検索は大文字小文字を区別しない
- **結果表示**: 「検索結果: N 件」で即座に更新
- **クリアボタン**: 検索条件をリセット

#### 2.2.3 パフォーマンス最適化
- **初回読み込み**: データキャッシュ実装
- **2回目以降**: キャッシュデータを即座に表示
- **キャッシュフラグ**: `supplyDataLoaded` で管理

---

### 2.3 ヘッダー機能

#### 2.3.1 最終更新日表示
- **表示形式**: 「最終更新: YYYY-MM-DD」
- **未更新時**: 「未更新」と表示
- **動的更新**: データ更新後にリアルタイム更新

#### 2.3.2 データ更新ボタン
- **ボタンテキスト**: 「🔄 厚労省データを更新」
- **機能**: 厚労省の最新医薬品供給データをダウンロード
- **成功時**: 「✅ データが更新されました。YYYY-MM-DD（ファイル名）」
- **スキップ時**: 「✅ データは最新です。YYYY-MM-DD（ファイル名）」

---

## 3. 画面仕様

### 3.1 UI 構成

```
┌─────────────────────────────────────────────────┐
│ 薬局向け医薬品供給状況チェッカー  最終更新: ...  🔄 │ (ヘッダー)
├─────────────────────────────────────────────────┤
│ │ 📋 ファイル照合 │ 📄 供給情報プレビュー     │ (タブナビ)
├─────────────────────────────────────────────────┤
│                                                   │
│  [ファイル選択] [照合実行]                        │ (ファイル選択エリア)
│  薬局のExcelファイルを選択してください           │
│  ─────────────────────────────────────────────  │
│                                                   │
│  結果テーブル（スクロール可能）                   │ (結果表示エリア)
│  ┌──────────┬──────┬──────┬──────┬──────┬──────┐ │
│  │コード    │成分名│規格  │メーカー│供給状況│更新日│ │
│  ├──────────┼──────┼──────┼──────┼──────┼──────┤ │
│  │...      │...  │...  │...  │...  │...  │ │
│  └──────────┴──────┴──────┴──────┴──────┴──────┘ │
│                                                   │
└─────────────────────────────────────────────────┘
```

### 3.2 レスポンシブデザイン
- **フルスクリーン対応**: `height: 100%` 設定
- **Flex レイアウト**: 要素の高さを動的に計算
- **スクロール対応**: 表示エリアは垂直スクロール可能
- **固定ヘッダー**: タブや検索ボックスはスクロール時も固定

---

## 4. 技術仕様

### 4.1 使用技術
- **バックエンド**: FastAPI (Python)
- **フロントエンド**: HTML5 + Bootstrap 5.3 + JavaScript
- **データ処理**: pandas
- **Excelファイル処理**: openpyxl
- **テンプレート**: Jinja2

### 4.2 ブラウザ対応
- Chrome/Chromium (推奨)
- Firefox
- Safari
- Edge

---

## 5. API 仕様

### 5.1 エンドポイント一覧

#### 5.1.1 GET /
**説明**: メインページを取得
**レスポンス**: HTML ページ + status 情報埋め込み
**Status Code**: 200 OK

**Response Data**:
```json
{
  "status": {
    "file_exists": boolean,
    "file_size": number,
    "last_checked": "YYYY-MM-DD",
    "last_modified": "YYYY-MM-DD",
    "url": string
  }
}
```

---

#### 5.1.2 POST /check
**説明**: Excelファイルを厚労省データと照合
**Request**: multipart/form-data (file: Excel)
**Status Code**: 200 OK

**Response Success**:
```json
{
  "success": true,
  "message": "照合完了",
  "stats": {
    "matched_rows": number,
    "recent_updates": number
  },
  "data": [
    {
      "pharmacy_薬品コード": "123456",
      "成分名": "●●●●",
      "④規格単位": "XXX",
      "⑦製造販売業者名": "YYY製薬",
      "供給状況": "◎出荷可能",
      "更新日": "2026-02-06"
    }
  ]
}
```

**Response Error**:
```json
{
  "success": false,
  "message": "エラーメッセージ"
}
```

---

#### 5.1.3 GET /preview-supply
**説明**: 厚労省医薬品供給データをプレビュー
**Status Code**: 200 OK

**Response**:
```json
{
  "success": true,
  "columns": ["列名1", "列名2", ...],
  "data": [
    {
      "列名1": "値1",
      "列名2": "値2"
    }
  ],
  "total_rows": number
}
```

---

#### 5.1.4 POST /refresh
**説明**: 厚労省データを更新
**Status Code**: 200 OK

**Response Success (Updated)**:
```json
{
  "success": true,
  "message": "✅ データが更新されました。2026-02-06（260206iyakuhinkyoukyu.xlsx）",
  "cached": false,
  "last_checked": "2026-02-06"
}
```

**Response Success (Cached)**:
```json
{
  "success": true,
  "message": "✅ データは最新です。2026-02-06（260206iyakuhinkyoukyu.xlsx）",
  "cached": true,
  "last_checked": "2026-02-06"
}
```

---

### 5.2 HTTP ステータスコード
| コード | 説明 |
|--------|------|
| 200 | リクエスト成功 |
| 400 | リクエストエラー（ファイルなし等） |
| 404 | リソースなし |
| 500 | サーバーエラー |

---

## 6. データ仕様

### 6.1 薬品コード列パターン（20+）
```
"コード", "医薬品コード", "YJコード", "医薬品YJコード",
" код", "薬品番号", "製品コード", "商品コード",
"ID", "item code", "Product Code", ...
```

### 6.2 薬品名列パターン（25+）
```
"薬品名", "品名", "製品名", "商品名",
"医薬品名", "成分名", "一般名", "品目名",
"Name", "Product Name", "Item Name", ...
```

### 6.3 カラム検出ロジック
1. ユーザーのExcelファイルのヘッダー行を走査
2. 各列名とパターンを比較（`in` 演算子で部分一致）
3. マッチした最初の列を採用
4. コード列と名前列を同時に検出

---

## 7. キャッシング戦略

### 7.1 サーバーサイドキャッシュ
- **キャッシュディレクトリ**: `./cache/`
- **キャッシュファイル**: 厚労省ExcelファイルのZIP
- **メタデータ**: `metadata.json`に保存

**メタデータ構造**:
```json
{
  "downloaded_at": "2026-02-06",
  "last_modified": "2026-02-06T00:00:00",
  "url": "https://example.mhlw.go.jp/...",
  "file_hash": "abc123def456"
}
```

### 7.2 クライアントサイドキャッシュ
- **キャッシュ変数**: `supplyDataCache`, `supplyDataLoaded`
- **キャッシュ対象**: 供給情報プレビューのテーブルデータ
- **クリア条件**: ページ再読み込み時にクリア

---

## 8. エラーハンドリング

### 8.1 ユーザー側エラー
| エラー | メッセージ | 対処 |
|--------|-----------|------|
| ファイル未選択 | 「ファイルを選択してください」 | ファイルを選択してクリック |
| 不正なファイル形式 | 「Excelファイルのみに対応しています」 | .xlsxファイルを選択 |
| 照合列なし | 「列の判定ができません。ファイルを確認してください」 | ファイルのヘッダー行を確認 |
| マッチなし | 「該当する医薬品がありません」 | ファイル内容を確認 |

### 8.2 システム側エラー
- **データダウンロード失敗**: ネットワーク確認、リトライト
- **Excelパース失敗**: ファイル破損の可能性を通知
- **キャッシュエラー**: ディスク容量確認

---

## 9. パフォーマンス要件

### 9.1 レスポンス時間
| 操作 | 目標時間 |
|------|---------|
| ページ初期表示 | < 2秒 |
| ファイル照合 | < 5秒 |
| 供給情報プレビュー（初回） | < 3秒 |
| 供給情報プレビュー（キャッシュ） | < 0.5秒 |
| タブ切り替え | < 0.3秒 |
| 検索フィルター | < 0.5秒 |

### 9.2 メモリ使用量
- **Excelファイル**: 最大 100MB 対応
- **データベース**: 約 20,000 件対応
- **ブラウザ**: 200MB 以内を目安

---

## 10. セキュリティ仕様

### 10.1 入力検証
- **ファイル拡張子**: .xlsx, .xls のみ許可
- **ファイルサイズ**: 100MB 上限
- **Excelシート数**: 制限なし

### 10.2 データセキュリティ
- **アップロードファイル**: メモリ処理（ディスク保存なし）
- **キャッシュデータ**: ローカルディレクトリ（外部非公開）
- **ブラウザ通信**: HTTP（ローカル使用想定）

---

## 11. 今後の拡張可能性

### 11.1 予定されている機能
- [ ] 複数ファイルの同時照合
- [ ] CSVファイル対応
- [ ] 照合結果のダウンロード機能
- [ ] 照合履歴の管理
- [ ] ユーザー設定（言語、色テーマ等）

### 11.2 技術的拡張
- [ ] HTTPS 対応（本番運用時）
- [ ] ユーザー認証
- [ ] ログイン機能
- [ ] 複数ユーザーの同時利用対応
- [ ] データベース連携（SQLite/PostgreSQL）

---

## 12. 導入・運用

### 12.1 システム要件
- **OS**: Windows, macOS, Linux
- **Python**: 3.9+
- **ポート**: 8000（デフォルト）
- **ディスク**: 最小 1GB

### 12.2 起動方法
```bash
python main.py
```

アプリケーションは `http://127.0.0.1:8000` で起動します。

### 12.3 ファイル構成
```
pharmacy-drug-checker/
├── main.py                    # FastAPI メインアプリ
├── app/
│   ├── config.py             # 設定・パターン定義
│   ├── mhlw_downloader.py    # データダウンロード・キャッシング
│   ├── excel_matcher.py      # Excel照合エンジン
│   └── excel_reader.py       # Excel読み込み
├── templates/
│   └── index.html            # フロントエンド（Jinja2テンプレート）
├── static/                    # 静的ファイル
├── cache/                     # キャッシュディレクトリ
├── sample/                    # サンプルファイル
└── SPECIFICATION.md          # 本ドキュメント
```

---

## 13. トラブルシューティング

### 13.1 よくある問題
| 問題 | 原因 | 解決方法 |
|------|------|--------|
| 「ファイルが見つかりません」 | キャッシュなし | 「厚労省データを更新」をクリック |
| タブ切り替えが遅い | ブラウザのメモリ圧迫 | ブラウザを再起動 |
| 照合結果がない | 列名が非対応 | config.py のパターンを追加 |
| 表示が崩れている | フォントキャッシュ | ブラウザキャッシュをクリア |

---

## 14. 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|--------|
| 2026-02-08 | 1.0 | 初版作成 |

---

**ドキュメント終了**
